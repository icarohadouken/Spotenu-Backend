module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseError=void 0;class r extends Error{constructor(e,t){super(e),this.errorCode=t}}t.BaseError=r},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.stringToUserRole=t.User=t.UserRole=void 0;const r=n(3);var o;!function(e){e.NORMAL="NORMAL",e.ADMIN="ADMIN"}(o=t.UserRole||(t.UserRole={}));t.User=class{constructor(e,t,n,r,o,i){this.id=e,this.name=t,this.nickname=n,this.email=r,this.password=o,this.role=i}getId(){return this.id}getName(){return this.name}getNickname(){return this.nickname}getEmail(){return this.email}getPassword(){return this.password}getRole(){return this.role}},t.stringToUserRole=e=>{switch(e){case"NORMAL":return o.NORMAL;case"ADMIN":return o.ADMIN;default:throw new r.InvalidParameterError("Invalid user role")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidParameterError=void 0;const r=n(0);class o extends r.BaseError{constructor(e){super(e,422)}}t.InvalidParameterError=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnauthorizedError=void 0;const r=n(0);class o extends r.BaseError{constructor(e){super(e,403)}}t.UnauthorizedError=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotFoundError=void 0;const r=n(0);class o extends r.BaseError{constructor(e){super(e,404)}}t.NotFoundError=o},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDatabase=void 0;const i=o(n(21));class s{getConnection(){return s.connection||(s.connection=i.default({client:"mysql",connection:{host:process.env.DB_HOST,port:3306,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_DATABASE_NAME}})),s.connection}static destroyConnection(){return r(this,void 0,void 0,(function*(){s.connection&&(yield s.connection.destroy(),s.connection=null)}))}}t.BaseDatabase=s,s.connection=null},function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Authenticator=void 0;const s=i(n(22));class a{generateToken(e){return s.sign({id:e.id,role:e.role},process.env.JWT_KEY,{expiresIn:a.EXPIRES_IN})}generateTokenBand(e){return s.sign({id:e.id,authorization:e.authorization},process.env.JWT_KEY,{expiresIn:a.EXPIRES_IN})}verifyToken(e){const t=s.verify(e,process.env.JWT_KEY);return{id:t.id,role:t.role,authorization:t.authorization}}}t.Authenticator=a,a.EXPIRES_IN="1day"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdGenerator=void 0;const r=n(23);t.IdGenerator=class{generate(){return r.v4()}}},function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.HashManager=void 0;const a=i(n(24));t.HashManager=class{hash(e){return s(this,void 0,void 0,(function*(){const t=Number(process.env.ROUNDS),n=yield a.genSalt(t);return yield a.hash(e,n)}))}compare(e,t){return s(this,void 0,void 0,(function*(){return yield a.compare(e,t)}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Band=void 0;t.Band=class{constructor(e,t,n,r,o,i){this.id=e,this.name=t,this.nickname=n,this.description=r,this.password=o,this.authorization=i}getId(){return this.id}getName(){return this.name}getNickname(){return this.nickname}getDescription(){return this.description}getPassword(){return this.password}getAuthorization(){return this.authorization}}},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const o=r(n(12)),i=n(13);n(30),t.handler=o.default(i.app)},function(e,t){e.exports=require("serverless-http")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;const o=r(n(1)),i=r(n(14)),s=r(n(15)),a=r(n(16)),u=n(17),c=n(25);a.default.config(),t.app=o.default(),t.app.use(i.default({origin:!0})),t.app.use(o.default.json()),t.app.use(s.default()),t.app.use("/user/",u.userRouter),t.app.use("/band/",c.bandRouter)},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("express-fileupload")},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.userRouter=void 0;const o=n(18),i=r(n(1));t.userRouter=i.default.Router(),t.userRouter.post("/signup",(new o.UserController).signup),t.userRouter.post("/signup/admin",(new o.UserController).signupAdmin),t.userRouter.post("/login",(new o.UserController).login)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0;const o=n(19),i=n(20),s=n(7),a=n(8),u=n(9);class c{signup(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield c.UserBusiness.signup(e.body.name,e.body.nickname,e.body.email,e.body.password);t.status(200).send(n)}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}signupAdmin(e,t){return r(this,void 0,void 0,(function*(){try{yield c.UserBusiness.signupAdmin(e.headers.authorization,e.body.name,e.body.nickname,e.body.email,e.body.password);t.status(200).send({message:"User created"})}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}login(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield c.UserBusiness.login(e.body.login,e.body.password);t.status(200).send(n)}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}}t.UserController=c,c.UserBusiness=new o.UserBusiness(new i.UserDatabase,new u.HashManager,new s.Authenticator,new a.IdGenerator)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserBusiness=void 0;const o=n(2),i=n(3),s=n(4),a=n(5);t.UserBusiness=class{constructor(e,t,n,r){this.userDatabase=e,this.hashManager=t,this.authenticator=n,this.idGenerator=r}signup(e,t,n,s){return r(this,void 0,void 0,(function*(){if(!(e&&n&&s&&t))throw new i.InvalidParameterError("Missing input");if(-1===n.indexOf("@"))throw new i.InvalidParameterError("Invalid email");if(s.length<6)throw new i.InvalidParameterError("Password must contain at least 6 characters");const r=this.idGenerator.generate(),a=yield this.hashManager.hash(s);yield this.userDatabase.createUser(new o.User(r,e,t,n,a,o.UserRole.NORMAL));return{token:yield this.authenticator.generateToken({id:r,role:o.UserRole.NORMAL})}}))}signupAdmin(e,t,n,a,u){return r(this,void 0,void 0,(function*(){if(!e)throw new s.UnauthorizedError("Missing access token");if(this.authenticator.verifyToken(e).role!==o.UserRole.ADMIN)throw new s.UnauthorizedError("You must be an admin to use this endpoint");if(!(t&&a&&u&&n))throw new i.InvalidParameterError("Missing input");if(u.length<10)throw new i.InvalidParameterError("Your password must contain at least 10 characters");const r=this.idGenerator.generate(),c=yield this.hashManager.hash(u);yield this.userDatabase.createUser(new o.User(r,t,n,a,c,o.UserRole.ADMIN))}))}login(e,t){return r(this,void 0,void 0,(function*(){if(!e||!t)throw new i.InvalidParameterError("Missing input");const n=yield this.userDatabase.getUserByEmailOrNickname(e);if(!n)throw new a.NotFoundError("User not found");if(!(yield this.hashManager.compare(t,n.getPassword())))throw new i.InvalidParameterError("Invalid Password");return{accessToken:this.authenticator.generateToken({id:n.getId(),role:n.getRole()})}}))}}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserDatabase=void 0;const o=n(6),i=n(2);class s extends o.BaseDatabase{constructor(){super(...arguments),this.tableName="User"}toModel(e){return e&&new i.User(e.id,e.name,e.nickname,e.email,e.password,e.role)}createUser(e){const t=Object.create(null,{getConnection:{get:()=>super.getConnection}});return r(this,void 0,void 0,(function*(){yield t.getConnection.call(this).insert(e).into(this.tableName)}))}getUserByEmailOrNickname(e){return r(this,void 0,void 0,(function*(){const t=yield this.getConnection().select("*").from(this.tableName).where({email:e});if(!t[0]){const t=yield this.getConnection().select("*").from(this.tableName).where({nickname:e});return this.toModel(t[0])}return this.toModel(t[0])}))}}t.UserDatabase=s},function(e,t){e.exports=require("knex")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("bcryptjs")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.bandRouter=void 0;const o=n(26),i=r(n(1));t.bandRouter=i.default.Router(),t.bandRouter.post("/signup",(new o.BandController).signup),t.bandRouter.get("/",(new o.BandController).getBands),t.bandRouter.put("/approve/",(new o.BandController).approveBand),t.bandRouter.post("/login",(new o.BandController).login)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandController=void 0;const o=n(27),i=n(28),s=n(9),a=n(7),u=n(8);class c{signup(e,t){return r(this,void 0,void 0,(function*(){try{yield c.BandBusiness.signup(e.body.name,e.body.nickname,e.body.description,e.body.password);t.status(200).send({message:"Band created"})}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}getBands(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield c.BandBusiness.getBands(e.headers.authorization);t.status(200).send(n)}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}approveBand(e,t){return r(this,void 0,void 0,(function*(){try{yield c.BandBusiness.authorizeBand(e.headers.authorization,e.query.id),t.status(200).send({message:"Band approved sucessfully"})}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}login(e,t){return r(this,void 0,void 0,(function*(){try{const n=yield c.BandBusiness.login(e.body.login,e.body.password);t.status(200).send(n)}catch(e){t.status(e.errorCode||400).send({message:e.message})}}))}}t.BandController=c,c.BandBusiness=new i.BandBusiness(new o.BandDatabase,new s.HashManager,new a.Authenticator,new u.IdGenerator)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandDatabase=void 0;const o=n(6),i=n(10);class s extends o.BaseDatabase{constructor(){super(...arguments),this.tableName="Band"}toModel(e){return e&&new i.Band(e.id,e.name,e.email,e.nickname,e.password,e.authorization)}createBand(e){return r(this,void 0,void 0,(function*(){yield this.getConnection().insert(e).into(this.tableName)}))}getBands(){return r(this,void 0,void 0,(function*(){return yield this.getConnection().select("id","name","nickname","authorization").from(this.tableName)}))}getBandById(e){return r(this,void 0,void 0,(function*(){const t=yield this.getConnection().select("*").from(this.tableName).where({id:e});return this.toModel(t[0])}))}getBandByNickname(e){return r(this,void 0,void 0,(function*(){const t=yield this.getConnection().select("*").from(this.tableName).where({nickname:e});return this.toModel(t[0])}))}approveBand(e){return r(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n                UPDATE ${this.tableName}\n                SET authorization = true\n                where id = '${e}'\n            `)}))}}t.BandDatabase=s},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.BandBusiness=void 0;const o=n(10),i=n(3),s=n(4),a=n(29),u=n(5),c=n(2);t.BandBusiness=class{constructor(e,t,n,r){this.bandDatabase=e,this.hashManager=t,this.authenticator=n,this.idGenerator=r}signup(e,t,n,s){return r(this,void 0,void 0,(function*(){if(!(e&&t&&n&&s))throw new i.InvalidParameterError("Missing input");if(s.length<6)throw new i.InvalidParameterError("Password must contain at least 6 characters");const r=this.idGenerator.generate(),a=yield this.hashManager.hash(s);yield this.bandDatabase.createBand(new o.Band(r,e,t,n,a,0))}))}getBands(e){return r(this,void 0,void 0,(function*(){if(!e)throw new s.UnauthorizedError("Missing access token");if(this.authenticator.verifyToken(e).role!==c.UserRole.ADMIN)throw new s.UnauthorizedError("You must be an admin to use this endpoint");return yield this.bandDatabase.getBands()}))}authorizeBand(e,t){return r(this,void 0,void 0,(function*(){if(!e)throw new s.UnauthorizedError("Missing access token");if(this.authenticator.verifyToken(e).role!==c.UserRole.ADMIN)throw new s.UnauthorizedError("You must be an admin to use this endpoint");const n=yield this.bandDatabase.getBandById(t);if(1===(null==n?void 0:n.getAuthorization()))throw new a.GenericError("Band already approved");yield this.bandDatabase.approveBand(t)}))}login(e,t){return r(this,void 0,void 0,(function*(){if(!e||!t)throw new i.InvalidParameterError("Missing input");const n=yield this.bandDatabase.getBandByNickname(e);if(!n)throw new u.NotFoundError("Band not found");if(!(yield this.hashManager.compare(t,n.getPassword())))throw new i.InvalidParameterError("Invalid password");if(0===n.getAuthorization())throw new s.UnauthorizedError("Band need to be approved by an admin");return{accessToken:this.authenticator.generateTokenBand({id:n.getId(),authorization:n.getAuthorization()})}}))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GenericError=void 0;const r=n(0);class o extends r.BaseError{constructor(e){super(e,400)}}t.GenericError=o},function(e,t){e.exports=require("mysql")}]);